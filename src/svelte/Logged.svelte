<script lang="ts">
  import type { Users, User, BlockUsers, BlockUser } from "src/types"

  import { fade, slide } from "svelte/transition"
  const duration = { duration: 300 }

  import ProgressCircle from "svelte-progresscircle"

  //NOTE テスト用
  // import testdata from "../../testdata.json"
  const testdata = { following: {}, search: {} }
  const localDebug = false

  export let cookie

  function post(url) {
    const u = new URL("https://blocker.hmpf.club" + url)
    u.searchParams.set("access_token", cookie["access_token"])
    u.searchParams.set("access_token_secret", cookie["access_token_secret"])
    url = u.toString()
    return fetch(url, {
      method: "POST",
    })
  }
  function get(url) {
    const u = new URL("https://blocker.hmpf.club" + url)
    u.searchParams.set("access_token", cookie["access_token"])
    u.searchParams.set("access_token_secret", cookie["access_token_secret"])
    url = u.toString()
    return fetch(url, {
      method: "GET",
    })
  }

  let blocklist =
    "1517951340336402432,1515252940608778240,1235518101501796352,1518263222188802048"
  let blocktype: "screen_name" | "id" = "id"
  let blocking = false
  let blockProgress = 0
  let promiseBlockUsers: Promise<BlockUsers> = null

  $: blockIds = blocklist.split(",").filter((v) => v !== "")

  async function block() {
    console.log(blocktype)
    blocking = true
    promiseBlockUsers = new Promise<BlockUsers>(async (resolve) => {
      blockProgress = 0
      const result: BlockUsers = {}
      await Promise.all(
        blockIds.map(async (id) => {
          const data = localDebug
            ? new Response(
                await new Promise((resolve) =>
                  setTimeout(
                    () => resolve(JSON.stringify(testdata.following)),
                    1000
                  )
                )
              )
            : await post("/block?" + blocktype + "=" + id)
          const { statusText } = data
          const dataJson = await data.json()
          const ok = !("errors" in dataJson)
          result[id] = {
            data: ok ? await dataJson : undefined,
            ok,
            statusText,
          }
          blockProgress++
        })
      )
      setTimeout(() => {
        blocking = false
        promiseBlockUsers = null
      }, 2400)
      resolve(result)
    })
  }
</script>

<header>
  <h1>BlockList</h1>
</header>

<main id="logged">
  {#if promiseBlockUsers !== null}
    <div
      class="block_progress"
      transition:slide={{ duration: duration.duration * 2 }}
    >
      <ProgressCircle max={blockIds.length} value={blockProgress}>
        {#await promiseBlockUsers}
          <span class="block_progress_text" in:fade={duration}
            ><span>{Math.round((blockProgress / blockIds.length) * 100)}</span
            >%</span
          >
        {:then}
          <svg
            class="block_complete_icon"
            transition:slide={duration}
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 24 24"
            ><path d="M0 0h24v24H0V0z" fill="none" /><path
              d="M9 16.2L4.8 12l-1.4 1.4L9 19 21 7l-1.4-1.4L9 16.2z"
            /></svg
          >
        {/await}
      </ProgressCircle>
    </div>
    {#await promiseBlockUsers}
      <div class="users_count" in:slide={duration}>
        <span>{blockIds.length}</span>人をブロックしています……
      </div>
    {:then blockUsers}
      <div class="users_count" in:fade={duration} out:slide={duration}>
        <span>{Object.values(blockUsers).filter(({ ok }) => ok).length}</span
        >人をブロックしました
      </div>
    {/await}
  {/if}

  <div class="sn_id_radio">
    <div>
      <div>
        <input
          type="radio"
          id="screen_name"
          name="type"
          value="screen_name"
          checked
          bind:group={blocktype}
        />
        <label for="screen_name">Screen Name</label>
      </div>
      <div>
        <input
          type="radio"
          id="id"
          name="type"
          value="id"
          bind:group={blocktype}
        />
        <label for="id">ID</label>
      </div>
    </div>
    <div class="coc_info">
      <p>CoCシナリオネタバレアカウントを一括ブロックすることが出来ます。</p>
      <p>
        <a href="https://twitter.com/CoCntbrBlocker">開発アカウント</a>/
        <a href="https://l1n4r1a.booth.pm/items/3813812"
          >作者を支援する(投げ銭)</a
        >
      </p>
    </div>
  </div>

  <textarea class="block_users_textarea" bind:value={blocklist} />
  <div class="sticky_container">
    <div class="top_cover">
      <button
        class="block"
        on:click={() => {
          const scroll = document.body.animate(
            [{ marginTop: `-${window.pageYOffset - 1}px` }, { marginTop: 0 }],
            {
              duration: duration.duration,
              easing: "ease-in-out",
            }
          )
          window.scroll(0, 0)
          blocking = true
          scroll.addEventListener("finish", () => {
            block()
          })
        }}
        disabled={!Boolean(blocklist) || blocking}
        >{blockIds.length
          ? `${blockIds.length}人をブロックする`
          : `${blocktype}が指定されていません`}</button
      >
    </div>
  </div>
</main>

<!-- <footer>
  <iframe loading="lazy" src={footerUrl} title="footer" />
</footer>
<iframe src={sideUrl} title="side" /> -->
